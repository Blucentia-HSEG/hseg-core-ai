@echo off
setlocal enabledelayedexpansion

:: Set console appearance
title HSEG AI - Codex CLI Dataset Generator (No API Credits)
color 0A

:: Display comprehensive header
echo.
echo ================================================================================
echo            HSEG AI SYSTEM - CODEX CLI DATASET GENERATOR
echo                     OpenAI Codex via CLI Application
echo ================================================================================
echo.
echo üéØ MISSION: Generate synthetic dataset using OpenAI Codex CLI
echo.
echo üìä DATASET SPECIFICATIONS:
echo    ‚Ä¢ AI Engine: OpenAI Codex through CLI application (NO API CREDITS NEEDED)
echo    ‚Ä¢ Dataset Size: Auto-adjusted based on system memory
echo    ‚Ä¢ Rich Narratives: Codex-generated responses with demographic consistency
echo    ‚Ä¢ Company Realism: 55 detailed organizations across 3 domains
echo    ‚Ä¢ Psychological Authenticity: Research-backed trauma patterns
echo.
echo ü§ñ CODEX CLI ADVANTAGES:
echo    ‚Ä¢ No API credits or costs required
echo    ‚Ä¢ Uses local Codex CLI application
echo    ‚Ä¢ Same OpenAI model quality as API
echo    ‚Ä¢ Faster processing with CLI optimizations
echo    ‚Ä¢ Offline-capable once CLI is set up
echo.
echo üè¢ COMPANY COVERAGE (55 TOTAL):
echo    ‚Ä¢ Healthcare: 20 organizations (Kaiser, Mayo, Cleveland Clinic+)
echo    ‚Ä¢ Universities: 15 institutions (Harvard, Stanford, MIT, UC System+)
echo    ‚Ä¢ Business: 20 corporations (Microsoft, Google, Amazon, Apple+)
echo.
echo ‚ö†Ô∏è  REQUIREMENTS:
echo    ‚Ä¢ Processing Time: 10-25 minutes depending on dataset size
echo    ‚Ä¢ Memory Usage: Adaptive (1-4GB RAM, auto-adjusts)
echo    ‚Ä¢ Storage: ~50-150MB final CSV file
echo    ‚Ä¢ Dependencies: Python 3.8+, pandas, numpy, psutil
echo    ‚Ä¢ Codex CLI: OpenAI Codex CLI application installed and configured
echo.
echo ================================================================================
echo.
echo üöÄ READY TO GENERATE WITH CODEX CLI?
echo.
pause

:: System checks
echo üìã PERFORMING SYSTEM COMPATIBILITY CHECKS...
echo.

:: Check Python version
python --version >nul 2>&1
if errorlevel 1 (
    echo ‚ùå CRITICAL ERROR: Python not found in system PATH
    echo.
    echo üîß RESOLUTION STEPS:
    echo    1. Install Python 3.8 or higher from python.org
    echo    2. Ensure Python is added to system PATH during installation
    echo    3. Restart command prompt and try again
    echo.
    pause
    exit /b 1
)

:: Get and display Python version
for /f "tokens=2" %%a in ('python --version 2^>^&1') do set PYTHON_VERSION=%%a
echo ‚úÖ Python !PYTHON_VERSION! detected

:: Check Codex CLI availability
echo üìã Checking OpenAI Codex CLI availability...
codex --version >nul 2>&1
if errorlevel 1 (
    echo ‚ùå CRITICAL ERROR: Codex CLI not found
    echo.
    echo üîß CODEX CLI SETUP REQUIRED:
    echo    1. Install OpenAI Codex CLI application
    echo    2. Ensure 'codex' command is in your system PATH
    echo    3. Login to your OpenAI account: codex auth login
    echo    4. Test with: codex --version
    echo.
    echo üìû Download Codex CLI from: https://openai.com/codex
    echo.
    pause
    exit /b 1
) else (
    for /f "tokens=*" %%a in ('codex --version 2^>^&1') do set CODEX_VERSION=%%a
    echo ‚úÖ Codex CLI detected: !CODEX_VERSION!
)

:: Check available memory
for /f "tokens=2 delims=:" %%a in ('wmic OS get TotalVisibleMemorySize /value ^| find "="') do set TOTAL_MEM=%%a
set /a TOTAL_MEM_GB=!TOTAL_MEM!/1048576
if !TOTAL_MEM_GB! LSS 2 (
    echo ‚ö†Ô∏è  WARNING: Low system memory detected (!TOTAL_MEM_GB!GB)
    echo    Dataset will be optimized for small size (1,000 records)
    echo    Continue anyway? (Y/N)
    set /p CONTINUE=
    if /i not "!CONTINUE!"=="Y" exit /b 1
) else (
    echo ‚úÖ Sufficient memory available (!TOTAL_MEM_GB!GB)
)

:: Check and install required packages
echo üì¶ Verifying Python dependencies...
python -c "import pandas, numpy, uuid, datetime, json, re, itertools, psutil" 2>nul
if errorlevel 1 (
    echo ‚ö†Ô∏è  Missing required packages. Installing automatically...
    echo.
    echo üì• Installing: pandas numpy psutil
    pip install pandas numpy psutil --quiet --disable-pip-version-check
    if errorlevel 1 (
        echo ‚ùå Failed to install required packages
        echo.
        echo üîß MANUAL INSTALLATION:
        echo    pip install pandas numpy psutil
        echo.
        pause
        exit /b 1
    )
    echo ‚úÖ Dependencies installed successfully
) else (
    echo ‚úÖ All required packages available
)

:: Validate project structure
cd /d "%~dp0\.."
if not exist "scripts\hseg_codex_cli_generator.py" (
    echo ‚ùå ERROR: Required generator script not found
    echo Expected: scripts\hseg_codex_cli_generator.py
    echo Current directory: %CD%
    pause
    exit /b 1
)

echo ‚úÖ Project structure validated
echo üìÅ Working directory: %CD%

:: Create output directory
if not exist "data" (
    echo üìÇ Creating data directory...
    mkdir data
)

:: Disk space check
for /f "usebackq delims=" %%i in (`dir /s /-c "%CD%" 2^>nul ^| find "bytes free"`) do set DISK_SPACE=%%i
echo ‚úÖ Disk space: %DISK_SPACE%

echo.
echo ================================================================================
echo                      INITIATING CODEX CLI DATA GENERATION
echo ================================================================================
echo.
echo ‚è≥ GENERATION PROCESS STARTING...
echo.
echo üìä Process Details:
echo    ‚Ä¢ Using OpenAI Codex CLI for narrative generation
echo    ‚Ä¢ Batch processing in small chunks for memory efficiency
echo    ‚Ä¢ Progress updates every 50 records within each batch
echo    ‚Ä¢ Dataset size automatically optimized for your system
echo.
echo üéØ Target Output: data\hseg_55companies_codex_dataset.csv
echo.
echo ‚ö° Beginning Codex CLI generation at %TIME%...
echo.

:: Record start time
set START_TIME=%TIME%

:: Execute the Codex CLI generation script
python scripts/hseg_codex_cli_generator.py
set GENERATION_RESULT=!errorlevel!

:: Record end time
set END_TIME=%TIME%

echo.
echo ================================================================================

if !GENERATION_RESULT! equ 0 (
    echo                    ‚úÖ CODEX CLI GENERATION COMPLETED SUCCESSFULLY
    echo ================================================================================
    echo.
    echo ‚è±Ô∏è  Generation completed at %END_TIME%
    echo üìä Processing time: Started %START_TIME% ‚Üí Finished %END_TIME%
    echo.

    :: Validate output file
    if exist "data\hseg_55companies_codex_dataset.csv" (
        for %%A in ("data\hseg_55companies_codex_dataset.csv") do set FILE_SIZE=%%~zA
        set /a FILE_SIZE_MB=!FILE_SIZE!/1048576
        echo üìÅ Output file: data\hseg_55companies_codex_dataset.csv
        echo üíæ File size: !FILE_SIZE_MB! MB (!FILE_SIZE! bytes)

        :: Count actual records
        for /f %%i in ('type "data\hseg_55companies_codex_dataset.csv" ^| find /c /v ""') do set ACTUAL_LINES=%%i
        set /a ACTUAL_RECORDS=!ACTUAL_LINES!-1
        echo üìä Records generated: !ACTUAL_RECORDS!

        echo.
        echo üéØ DATASET VALIDATION:
        python -c "
import pandas as pd
try:
    df = pd.read_csv('data/hseg_55companies_codex_dataset.csv')
    print(f'‚úÖ CSV structure valid: {len(df)} rows, {len(df.columns)} columns')
    print(f'‚úÖ Domain distribution: {dict(df[\"domain\"].value_counts())}')
    print(f'‚úÖ Narrative length: Q24 avg {df[\"q24_text\"].str.len().mean():.0f} chars')
    print(f'‚úÖ No missing data: {df.isnull().sum().sum()} null values')
    print(f'‚úÖ Demographic consistency: Gender distribution {dict(df[\"gender_identity\"].value_counts())}')
except Exception as e:
    print(f'‚ùå Validation error: {e}')
"

        echo.
        echo üöÄ CODEX CLI ADVANTAGES REALIZED:
        echo    ‚úÖ No API credits consumed
        echo    ‚úÖ OpenAI-quality narratives generated
        echo    ‚úÖ Demographic consistency maintained
        echo    ‚úÖ Psychological authenticity preserved
        echo    ‚úÖ Memory-optimized processing completed

    ) else (
        echo ‚ùå ERROR: Output file not found despite successful execution
        echo Expected: data\hseg_55companies_codex_dataset.csv
        echo.
        echo üîç TROUBLESHOOTING:
        echo    1. Check write permissions in data directory
        echo    2. Verify sufficient disk space
        echo    3. Review error messages above
    )

) else (
    echo                           ‚ùå GENERATION FAILED
    echo ================================================================================
    echo.
    echo üîç FAILURE ANALYSIS:
    echo    ‚Ä¢ Exit code: !GENERATION_RESULT!
    echo    ‚Ä¢ Check error messages above for specific issues
    echo.
    echo üõ†Ô∏è  COMMON SOLUTIONS:
    echo    1. Verify Codex CLI setup: codex --version
    echo    2. Login to Codex CLI: codex auth login
    echo    3. Ensure Python packages: pip install pandas numpy psutil
    echo    4. Free up disk space (need ~100MB available)
    echo    5. Close memory-intensive applications
    echo    6. Run as administrator if permission issues
    echo.
    echo üìû CODEX CLI SUPPORT:
    echo    ‚Ä¢ Check Codex CLI documentation
    echo    ‚Ä¢ Verify OpenAI account status
    echo    ‚Ä¢ Test CLI with simple prompt first
)

echo.
echo ================================================================================
echo                              PROCESS COMPLETE
echo ================================================================================
echo.
echo üìä GENERATION SUMMARY:
echo    ‚Ä¢ Start time: %START_TIME%
echo    ‚Ä¢ End time: %END_TIME%
echo    ‚Ä¢ Result: !GENERATION_RESULT!
echo    ‚Ä¢ Output: data\hseg_55companies_codex_dataset.csv
echo    ‚Ä¢ AI Engine: OpenAI Codex CLI (No API Credits Used)
echo.
echo üéØ Your Codex CLI-powered synthetic dataset is ready for NLP model training!
echo.
echo Press any key to exit...
pause >nul